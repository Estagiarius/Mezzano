# Defstruct extensions

Mezzano supports a number of extentions to the `defstruct` facility, primarily to allow more precise control over the in-memory layout of instances.

## Struct option `:area`

`(:area area-name)`

Sets the allocation area for the struct.
By default structs are allocated in the general allocation area, which is both pageable and copyable.

`area-name` must be a valid allocation area name, currently one of `:pinned` or `:wired`.

## Struct option :sealed

`:sealed`

Prevents the structure from being included in other defstruct definitions as part of an `:include` option, or more generally being used as a superclass. It also prevents redefinition of the defstruct.

Specifying this option allows for faster type checking and other optimizations.

## Struct option :slot-offsets

`:slot-offsets`

Generates constants of the form `+SLOT-ACCESSOR-NAME+` (in other words, the accessor function name for the given slot with `+` prepended and appended) for each slot that contain the _offset_ of the slot.

The _offset_ of a slot is the index of the slot in word units counting from the first non-header word of the slot. It can be used directly in the slot argument of the `:object` addressing mode in the assembler. As it is represented in word units, it cannot index sub-word slots, such as those using a ub8 representation.

This option is incompatible with `:slot-locations`. The `:slot-locations` option should be used for new structs, as it is more flexible.

## Struct option :slot-locations

`:slot-locations`

Generates constants of the form `+SLOT-ACCESSOR-NAME+` (in other words, the accessor function name for the given slot with `+` prepended and appended) for each slot that contain the _location_ of the slot.

A _location_ is a value that carries both the byte offset and type of the slot. It can be used with the `instance-access` function, the `:object-location` addressing mode in the assembler, and other location-related functions. It can fully represent the location of any kind of slot in a struct.

This option is incompatible with `:slot-offsets`.

## Slot option :documentation

`(:documentation string)`

Provides a _documentation string_ for the slot. Slot documentation is accessible via the `documentation` slot of that slot's slot-definition object, accessible via the MOP.

## Slot option :dcas-sibling

`(:dcas-sibling slot-name)`

Enables use of the `double-compare-and-swap` macro on this slot and its sibling slot. `double-compare-and-swap` (DCAS) allows two slots within the same structure to be atomically compared and swapped together, similar to the single-slot `compare-and-swap` function. It corresponds to the x86-64 instruction `cmpxchg16b` or the A64 instruction `casp`.

_slot-name_ names another slot within the defstruct definition that this slot is paired with, for the purposes of `double-compare-and-swap`. That slot must have a matching `:dcas-sibling` option referring to this slot.

Due to machine implementation constraints, the slots must not use the `:align` option, must not specify a non-word-size type using the `:type` option, and the two slots must be defined together with no unrelated slots inbetween.

### Example

```
(defstruct object-pool
  ;; Using a generation count avoids the ABA problem.
  (generation 0 :dcas-sibling head :type fixnum)
  (head nil :dcas-sibling generation))
```

Defines an object pool type with a generation counter (of type fixnum) and a list head that can both be updated atomically using `double-compare-and-swap`.

## Slot option :align

`(:align slot-alignment)`

Override the default alignment for this slot.

_slot-alignment_ must be one of `nil`, 1, 2, 4, 8, or 16.

By default slots are naturally aligned (that is, they are aligned based on their data size), but this option allows the alignment to be increased or decreased. Certain architectures may require that slots of specific data types have a certain alignment, violating these constraints is an error.

`NIL` specifies the default alignment for that slot.

## Slot option :fixed-vector

`(:fixed-vector length)`

This changes the slot so that it contains a fixed-length vector, with the specified _length_, of values embedded directly in the structure object. Since the vector is embedded in the instance it is not accessible as a normal Lisp vector and cannot be treated as a sequence.

The slot-initform is used to fill each element of the fixed-vector (like the `:initial-element` option to `make-array`).

The accessor functions for the slot are extended to take an additional index argument, which specifies the index into the vector to access.

The offsets/locations generated by `:slot-offsets`/`:slot-locations` refer to slot 0 in the vector.

Attempting to access the slot via `slot-value` will instead treat the slot as an array of values.

`(slot-value foo 'fv-slot)` => `#(1 2 3)`

Printing and reading the struct will also treat the slot as a normal vector: `#S(foo :fv-slot #(1 2 3))`.

## Slot option :type

`(:type type)`

Extends the standard Common Lisp `:type` option.

For certain types, a more compact or efficient can be used.

The types Fixnum, Unsigned- and Signed-Byte types of widths 8, 16, 32, and 64, Short-, Single- and Double-Float will be stored unboxed and will be packed together when possible to minimise storage space.

The representation types are reflected in the locations generated by the `:slot-locations` option.
